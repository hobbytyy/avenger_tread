# 量化回测系统策略开发文档

## 1. 概述

本文档旨在为开发者提供量化回测系统策略开发的规范和指导。通过遵循本文档的规范，开发者可以创建能够被系统正确识别和使用的策略模块。

## 2. 策略文件基本结构

每个策略文件必须是一个独立的Python模块，放置在`策略`目录下。策略文件的基本结构如下：

```python
import pandas as pd
import numpy as np

# 策略描述（必需）
STRATEGY_DESCRIPTION = "策略的简要描述"

# 策略参数描述（必需）
STRATEGY_PARAM_DESCRIPTIONS = [
    "参数1描述",
    "参数2描述",
    # ... 更多参数描述
]

def equity_signal(data_df: pd.DataFrame, *args) -> pd.Series:
    """
    策略信号生成函数（必需）
    :param data_df: 包含金融数据的 DataFrame，必须包含 '收盘价' 列
    :param args: 策略参数
    :return: 返回包含信号的 Series（1=做多，0=空仓）
    """
    # 策略实现代码
    pass
```

## 3. 必需组件说明

### 3.1 策略描述变量
每个策略文件必须包含以下两个全局变量：

1. `STRATEGY_DESCRIPTION`: 策略的简要描述文本
2. `STRATEGY_PARAM_DESCRIPTIONS`: 参数描述列表，用于在界面中显示参数提示

### 3.2 信号生成函数
每个策略必须实现 `equity_signal` 函数，该函数：
- 接收一个包含金融数据的 pandas DataFrame（必须包含'收盘价'列）
- 接收可变数量的参数（*args）
- 返回一个 pandas Series，其中 1 表示做多信号，0 表示空仓信号

## 4. 特殊策略类型

### 4.1 参数优化策略
参数优化策略是一种特殊类型的策略，除了基本组件外，还需要实现：

1. `optimize_parameters` 函数：用于执行参数优化
2. 需要导入目标策略的 `equity_signal` 函数进行优化计算

## 5. 策略开发示例

### 5.1 普通策略示例（双均线策略）
```python
import pandas as pd
import numpy as np

# 策略描述
STRATEGY_DESCRIPTION = "双均线择时策略：通过计算短期和长期均线的交叉来产生买卖信号。当短期均线上穿长期均线时买入，下穿时卖出。"

# 策略参数描述
STRATEGY_PARAM_DESCRIPTIONS = [
    "短期均线周期(如: 5)",
    "长期均线周期(如: 20)",
    "本金金额(如: 100000)",
    "手续费率(如: 0.001)",
    "参数 5"
]

def equity_signal(btc_df: pd.DataFrame, *args) -> pd.Series:
    """
    根据BTC数据，使用短期和长期均线择时信号
    :param btc_df: 包含 BTC 数据的 DataFrame，必须包含 '收盘价' 列
    :param args: 均线参数 
                 args[0]=短期均线周期，
                 args[1]=长期均线周期，
                 args[2]=本金金额（可选），
                 args[3]=手续费率（可选）
    :return: 返回包含信号的 Series（1=做多，0=空仓）
    """
    # ===== 获取策略参数
    short_n = int(args[0])  # 短期均线周期，例如5表示5日均线
    long_n = int(args[1])  # 长期均线周期，例如20表示20日均线
    # 本金和手续费参数是可选的，用于后续的收益计算
    principal = float(args[2]) if len(args) > 2 and args[2] else 100000.0  # 默认本金10万元
    fee_rate = float(args[3]) if len(args) > 3 and args[3] else 0.001  # 默认手续费率0.1%

    # ===== 计算均线
    ma_short = btc_df['收盘价'].rolling(short_n, min_periods=1).mean()
    ma_long = btc_df['收盘价'].rolling(long_n, min_periods=1).mean()

    # ===== 初始化信号 Series，默认空仓
    signals = pd.Series(np.nan, index=btc_df.index)

    # ===== 找出金叉买入信号（短期均线上穿长期均线）
    condition_buy = (ma_short > ma_long) & (ma_short.shift(1) <= ma_long.shift(1))
    signals[condition_buy] = 1.0

    # ===== 找出死叉平仓信号（短期均线下穿长期均线）
    condition_sell = (ma_short < ma_long) & (ma_short.shift(1) >= ma_long.shift(1))
    signals[condition_sell] = 0.0

    # ===== 持续持仓：将前一日信号延续到当前（信号填充）
    signals = signals.ffill().fillna(1)  # 默认开仓
    return signals
```

### 5.2 参数优化策略示例
```python
"""
参数优化策略
通过遍历不同的参数组合，寻找最优的策略参数配置
"""

import pandas as pd
import numpy as np
from itertools import product
import sys
import os
from concurrent.futures import ThreadPoolExecutor, as_completed
import multiprocessing
import time

# 添加项目根目录到Python路径
sys.path.append(os.path.join(os.path.dirname(__file__), '..'))

# 导入资金管理模块
from utils.money_management import calculate_trade_details

# 策略描述
STRATEGY_DESCRIPTION = "参数优化策略：通过遍历不同的参数组合，寻找最优的策略参数配置，适用于各种金融数据类型。支持生成所有可能的短期和长期均线组合（短期 < 长期）。"

# 策略参数描述
STRATEGY_PARAM_DESCRIPTIONS = [
    "优化策略名称(默认: MA双均线择时)",
    "参数范围开始值(如: 5)",
    "参数范围结束值(如: 60)",
    "本金金额(如: 100000)",
    "手续费率(如: 0.001)"
]

def equity_signal(data_df: pd.DataFrame, *args) -> pd.Series:
    """
    参数优化策略信号生成函数
    :param data_df: 包含金融数据的 DataFrame，必须包含 '收盘价' 列
    :param args: 策略参数
    :return: 返回包含信号的 Series（1=做多，0=空仓）
    """
    # 默认返回持有信号
    signals = pd.Series(1.0, index=data_df.index)
    return signals

def optimize_parameters(data_df: pd.DataFrame, strategy_func, param_ranges: dict, principal: float = 100000.0, fee_rate: float = 0.001, max_workers: int = None, progress_callback=None) -> dict:
    """
    优化策略参数（支持多线程加速）
    :param data_df: 包含金融数据的 DataFrame
    :param strategy_func: 策略函数
    :param param_ranges: 参数范围字典
    :param principal: 本金
    :param fee_rate: 手续费率
    :param max_workers: 最大工作线程数
    :param progress_callback: 进度更新回调函数
    :return: 包含优化结果的字典
    """
    # 优化实现代码
    pass
```

## 6. 策略文件命名规范

1. 文件名应使用有意义的名称，能够反映策略的功能
2. 文件名应使用英文或拼音，避免使用特殊字符
3. 文件名以 `.py` 扩展名结尾
4. 文件名不应以下划线开头

## 7. 策略测试与验证

开发完成后，应进行以下测试：

1. 确保策略文件能被系统正确加载
2. 验证 `equity_signal` 函数能正确生成交易信号
3. 检查策略描述和参数描述能正确显示在界面中
4. 测试策略在不同数据集上的表现

## 8. 注意事项

1. 策略文件中不要包含 `if __name__ == "__main__":` 代码块
2. 避免在策略文件中使用全局变量存储状态
3. 确保策略函数是纯函数，即相同输入应产生相同输出
4. 处理异常情况，避免程序崩溃
5. 优化策略应提供进度回调机制，以便在界面中显示进度